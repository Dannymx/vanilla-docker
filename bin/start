#!/usr/bin/env bash

DATA_STORAGE_CHECK=$(docker volume ls -q | grep datastorage);

if [ ! -n "$DATA_STORAGE_CHECK" ]; then
    echo "Looks like the data storage volume isn't configured. Did you forget to run the setup script?"
    exit 1;
fi

ORIG_PWD=$(pwd)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done

DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
VANILLA_DOCKER=$(dirname "$DIR")
cd $VANILLA_DOCKER

echo "Starting File Sync Service"
echo "Note this may take a while the first time."
echo "In particular it may take a while on something like this"
echo ""
echo "doing initial sync with unison
Unison 2.51.2 (ocaml 4.06.1): Contacting server...
Looking for changes"
echo ""
echo "Proceed anyways. I promise it's worth the wait."
echo "Subsequent starts should be faster."
echo ""
echo "It is recommended not to modify in any source code files during this first sync."
echo "=========================================="
echo ""
docker-sync start

echo "";
echo "Starting vanilla-docker"
echo "=========================="
echo ""

docker-compose \
-f "$VANILLA_DOCKER/docker-compose.yml" \
-f "$VANILLA_DOCKER/docker-compose.override.yml" \
-f "$VANILLA_DOCKER/service-sphinx.yml" \
-f "$VANILLA_DOCKER/service-memcached.yml" \
-f "$VANILLA_DOCKER/docker-compose.sync.yml" \
up --remove-orphans --build -d

cd $ORIG_PWD